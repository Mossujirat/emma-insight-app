<ng-container *ngIf="!isLoading; else loadingTemplate">
  <ng-container *ngIf="!hasError; else errorTemplate">
    <div class="statistics-container">
      <div class="row mb-4">
        <div class="col d-flex justify-content-between align-items-center">
          <h3 class="page-title">Statistics</h3>
          <button class="btn btn-download"><i class="bi bi-download me-2"></i>Download</button>
        </div>
      </div>

      <div class="row mb-4 align-items-center">
        <div class="col-md-6">
          <h4 class="section-title">Overall System Status</h4>
        </div>
        <div class="col-md-6 d-flex align-items-center justify-content-end">
          <label for="dateFrom" class="me-2 text-white-50">From</label>
          <input type="date" id="dateFrom" class="form-control me-3" [(ngModel)]="dateFrom" [min]="minSelectableDate" [max]="dateTo || maxSelectableDate">
          <i class="bi bi-arrow-right-short fs-4 me-3"></i>
          <label for="dateTo" class="me-2 text-white-50">To</label>
          <input type="date" id="dateTo" class="form-control me-3" [(ngModel)]="dateTo" [min]="dateFrom || minSelectableDate" [max]="maxSelectableDate">
          <button class="btn btn-confirm me-2" (click)="confirmDateChange()">Confirm</button>
          <button class="btn btn-clear me-2" (click)="clearDateFilter()">Clear</button>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-4">
          <div class="summary-item card bg-dark text-white p-3">
            <img src="assets/icons/vehicle_icon.png" alt="All Vehicles" class="summary-icon">
            <div class="summary-text">
              <span class="text-white-50">All Vehicles</span>
              <strong class="summary-value">{{ summary?.allVehicles }}</strong>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="summary-item card bg-dark text-white p-3">
            <img src="assets/icons/trip_icon.png" alt="All Trips" class="summary-icon">
            <div class="summary-text">
              <span class="text-white-50">All Trips</span>
              <strong class="summary-value">{{ summary?.allTrips }}</strong>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="summary-item card bg-dark text-white p-3">
            <img src="assets/icons/total_kilo_icon.png" alt="Total Kilometers Driven" class="summary-icon">
            <div class="summary-text">
              <span class="text-white-50">Total Kilometers Driven</span>
              <strong class="summary-value">{{ summary?.totalKilometers | number }}</strong>
            </div>
          </div>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-9">
          <div class="card bg-dark text-white p-3 chart-card">
            <canvas id="statisticsChart"></canvas>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-dark text-white p-3 filter-panel">
            <h6 class="filter-title">Vehicles</h6>
            <div class="btn-group-filter mb-3">
              <button *ngFor="let type of vehicleTypes"
                      class="btn btn-sm"
                      [ngClass]="selectedVehicleTypes.includes(type) ? 'btn-filter-active' : 'btn-filter-inactive'"
                      (click)="toggleVehicleType(type)">
                {{ type }}
              </button>
            </div>

            <h6 class="filter-title">Event Filter</h6>
            <div class="btn-group-filter mb-3">
              <button *ngFor="let event of eventFilters"
                      class="btn btn-sm"
                      [ngClass]="activeGraphGroup === 'event' && selectedGraphFilters.includes(event) ? 'btn-filter-active' : 'btn-filter-inactive'"
                      (click)="selectGraphFilter(event, 'event')">
                {{ event }}
              </button>
            </div>

            <h6 class="filter-title">Speed</h6>
            <div class="btn-group-filter">
              <button *ngFor="let speed of speedFilters"
                      class="btn btn-sm"
                      [ngClass]="activeGraphGroup === 'speed' && selectedGraphFilters.includes(speed) ? 'btn-filter-active' : 'btn-filter-inactive'"
                      (click)="selectGraphFilter(speed, 'speed')">
                {{ speed }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card bg-dark text-white p-4">
            <h4 class="mb-4">Rankings</h4>
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <button class="btn me-2" 
                        [ngClass]="{'btn-warning': activeRankingFilter === 'warning', 'btn-outline-warning': activeRankingFilter !== 'warning'}"
                        (click)="setRankingFilter('warning')">Warning</button>
                <button class="btn"
                        [ngClass]="{'btn-danger': activeRankingFilter === 'critical', 'btn-outline-danger': activeRankingFilter !== 'critical'}"
                        (click)="setRankingFilter('critical')">Critical</button>
              </div>
              <div class="d-flex">
                <select class="form-select me-2 bg-dark text-white border-secondary" 
                        [(ngModel)]="sortOrder" 
                        (ngModelChange)="applyRankingSortAndFilter()">
                  <option value="highToLow">Sort by: Risk (High to Low)</option>
                  <option value="lowToHigh">Sort by: Risk (Low to High)</option>
                </select>
                <div class="input-group">
                  <input type="text" 
                         class="form-control bg-dark text-white border-secondary" 
                         placeholder="Search ID, License Plate, Name..."
                         [(ngModel)]="searchText"
                         (ngModelChange)="applyRankingSortAndFilter()">
                  <span class="input-group-text bg-secondary text-white border-secondary"><i class="bi bi-search"></i></span>
                </div>
              </div>
            </div>

            <div class="table-scroll-container">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>ID</th>
                    <th>License Plate No.</th>
                    <th>Name</th>
                    <th>Vehicles</th>
                    <th class="text-capitalize">{{activeRankingFilter}} / duration</th>
                    <th>Quantity</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let rank of sortedRankings" [routerLink]="['/dashboard/statistics', rank.id]" class="driver-row">
                    <td>{{ rank.rank }}</td>
                    <td>{{ rank.id }}</td>
                    <td>{{ rank.licensePlateNo }}</td>
                    <td>{{ rank.name }}</td>
                    <td>
                      <span class="badge" [ngClass]="{
                        'bg-bus': rank.vehicles === 'Bus',
                        'bg-cargo': rank.vehicles === 'Cargo',
                        'bg-taxi': rank.vehicles === 'Taxi'
                      }">{{ rank.vehicles }}</span>
                    </td>
                    <td>{{ rank.durationDisplay }}</td>
                    <td>{{ rank.quantity }} times</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</ng-container>

<ng-template #loadingTemplate>
  <div class="d-flex flex-column justify-content-center align-items-center" style="height: 80vh;">
    <div class="spinner-border mb-3" role="status" style="width: 3rem; height: 3rem; ">
      <span class="visually-hidden">Loading...</span>
    </div>
    <h5>Loading Data...</h5>
  </div>
</ng-template>


<ng-template #errorTemplate>
  <div class="d-flex flex-column justify-content-center align-items-center text-center" style="height: 80vh;">
    <h4 class="mb-3">Data Not Found</h4>
    <p class="text-muted mb-4">A connection error may have occurred, or no data exists for the selected range.</p>
    <button class="btn btn-primary" (click)="refreshData()">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>
</ng-template>