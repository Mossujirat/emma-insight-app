<div class="dashboard-scroll-container">

  <div class="row custom-map-and-status-row">
    <div class="col-md-9 mb-4"> 
      <div class="card bg text p-3" style="min-height: 400px;">
        <h5><i class="bi bi-geo-alt-fill me-2"></i>Map</h5>
        <div class="map-section" style="height: 350px;"> <div *ngIf="loadingData" class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-50">Loading map data...</p>
          </div>
          <app-longdo-map *ngIf="!loadingData && driverList && driverList.length > 0"
                          [drivers]="filteredMapDrivers"  
                          [center]="mapCenter" 
                          [zoom]="mapZoom">
          </app-longdo-map>
          <div *ngIf="!loadingData && (!driverList || driverList.length === 0)" class="text-center py-5">
            <p class="mt-3 text-50">No driver data to display on map.</p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-4 d-flex flex-column">
      <div class="unified-status-card bg text p-3"> 
        <div *ngIf="loadingData" class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-50">Loading status...</p>
        </div>
        <ng-container *ngIf="!loadingData && summaryData">
          <div class="status-item d-flex justify-content-between align-items-center pb-2"
              [ngClass]="{'status-active': selectedMapStatus === 'Normal'}"
              (click)="centerMapOnStatus('Normal')">
            <span>Normal</span>
            <span class="fs-4 fw-bold text-success">{{ summaryData.noOnline - summaryData.noWarning - summaryData.noCritical }}</span>
          </div>
          <div class="status-item d-flex justify-content-between align-items-center py-2"
              [ngClass]="{'status-active': selectedMapStatus === 'Warning'}"
              (click)="centerMapOnStatus('Warning')">
            <span>Warning</span>
            <span class="fs-4 fw-bold text-warning">{{ summaryData.noWarning }}</span>
          </div>
          <div class="status-item d-flex justify-content-between align-items-center pt-2"
              [ngClass]="{'status-active': selectedMapStatus === 'Critical'}"
              (click)="centerMapOnStatus('Critical')">
            <span>Critical</span>
            <span class="fs-4 fw-bold text-danger">{{ summaryData.noCritical }}</span>
          </div>
          <hr class="status-separator custom-separator my-3">
          <div class="status-item d-flex justify-content-between align-items-center pt-2"
              [ngClass]="{'status-active': selectedMapStatus === 'Offline'}"
              (click)="centerMapOnStatus('Offline')">
            <span>Offline</span>
            <span class="fs-4 fw-bold text-secondary">{{ summaryData.noOffline }}</span>
          </div>
        </ng-container>
        <div *ngIf="!loadingData && !summaryData" class="text-center py-5">
            <p class="text-50">Status data not available.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 mt-4">
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5>Select Vehicles</h5>
          <div>
            <button *ngFor="let type of vehicleTypes"
                    class="btn btn-sm me-2"
                    [ngClass]="{
                      'btn-primary': selectedVehicleTypes.includes(type),
                      'btn-outline-secondary': !selectedVehicleTypes.includes(type)
                    }"
                    (click)="toggleVehicleTypeFilter(type)">
              {{ type }}
            </button>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <button *ngFor="let status of driverStatuses"
                    class="btn btn-sm me-2"
                    [ngClass]="{
                      'btn-light': selectedStatus === status, 
                      'btn-outline-light': selectedStatus !== status && status === 'All', 
                      'btn-outline-success': selectedStatus !== status && status === 'Online',
                      'btn-outline-warning': selectedStatus !== status && status === 'Warning',
                      'btn-outline-danger': selectedStatus !== status && status === 'Critical',
                      'btn-outline-secondary': selectedStatus !== status && status === 'Offline'
                    }"
                    (click)="toggleStatusFilter(status)">
              {{ status }}
            </button>
          </div>
          <div class="input-group w-25">
            <input type="text" 
                   class="form-control form-control-sm bg text border-secondary" 
                   placeholder="Search ID, Name, and License No."
                   [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()">  
            <span class="input-group-text bg-secondary textborder-secondary">
              <i class="bi bi-search"></i>
            </span>
          </div>
        </div>

        <div class="table-responsive">
          <div *ngIf="loadingData" class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-50">Loading driver list...</p>
          </div>
          <table *ngIf="!loadingData && filteredDriverList.length > 0" class="table table-striped table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>License Plate No.</th>
                <th>Driver</th>
                <th>Vehicles</th>
                <th>Updated</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let driver of filteredDriverList"
                  (click)="driver.available !== 'Offline' && viewDriverDetails(driver.driverId)"
                  [ngClass]="{'clickable-row': driver.available !== 'Offline', 'disabled-row': driver.available === 'Offline'}">
                <td>{{ driver.driverId }}</td>
                <td>{{ driver.carLicenseNo }}</td>
                <td>{{ driver.driverName }}</td>
                <td>{{ driver.vehicleType }}</td>
                <td>{{ driver.updated | date:'short' }}</td> 
                <td>
                  <span class="badge"
                        [ngClass]="{
                          'bg-secondary': driver.available === 'Offline',
                          'bg-danger': driver.available === 'Online' && driver.status === 'Critical',
                          'bg-success': driver.available === 'Online' && driver.status === 'Normal',
                          'bg-warning': driver.available === 'Online' && driver.status === 'Warning'
                        }">
                    {{ driver.available === 'Offline' ? 'Offline' : driver.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
          <div *ngIf="!loadingData && filteredDriverList.length === 0" class="text-center py-5">
            <p class="text-50">No driver data available.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>