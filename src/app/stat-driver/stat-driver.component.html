<div class="driver-stats-container" *ngIf="!isLoading && !hasError && driverData; else statusTemplate">
    <div class="header-section">
        <div class="header-top">
            <h3 class="page-title">Statistics</h3>
            <button class="btn btn-download"><i class="bi bi-download me-2"></i>Download</button>
        </div>
        <div class="header-bottom">
            <a class="back-link" (click)="goBack()"><i class="bi bi-chevron-left"></i> BACK</a>
        </div>
    </div>

    <div class="main-content">
        <div class="filter-bar">
            <div class="driver-info">
                <h4 class="driver-name">{{ driverData.driverInfo.name }}</h4>
                <p class="driver-details-text">
                  {{ driverData.driverInfo.licensePlateNo }} ({{ driverData.driverInfo.vehicleType }})
                </p>
            </div>
            <div class="col-md-6 d-flex align-items-center justify-content-end">
                <label for="dateFrom" class="me-2 text-white-50">From</label>
                <input type="date" id="dateFrom" class="form-control me-3" [(ngModel)]="dateFrom"
                       [min]="minSelectableDate" [max]="dateTo || maxSelectableDate">
                <i class="bi bi-arrow-right-short fs-4 me-3"></i>
                <label for="dateTo" class="me-2 text-white-50">To</label>
                <input type="date" id="dateTo" class="form-control me-3" [(ngModel)]="dateTo"
                       [min]="dateFrom || minSelectableDate" [max]="maxSelectableDate">
                <button class="btn btn-confirm me-2" (click)="confirmDateChange()">Confirm</button>
                <button class="btn btn-clear me-2" (click)="clearDateFilter()">Clear</button>
            </div>
        </div>

        <div class="dashboard-cards-section">
            <div class="chart-column">
                <div class="chart-card">
                    <div class="chart-wrapper">
                        <canvas #mainDriverChart id="mainDriverChart"></canvas>
                    </div>
                    <div class="detected-events-bar">
                        <span>Detected Event</span>
                        <div class="event-buttons">
                            <button *ngFor="let filter of detectedEventFilters"
                                    class="btn btn-event me-2"
                                    [ngClass]="{ 'active': isFilterActive(filter) }"
                                    (click)="toggleEventFilter(filter)">
                                {{ filter }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stats-column">
                <div class="stats-grid">
                    <div class="stat-card">
                        <p>Speeding Detected</p>
                        <span class="stat-value text-green">{{ driverData.summary.speedingDetected | number:'1.0-0' }}</span>
                    </div>
                    <div class="stat-card">
                        <p>Distance (Km)</p>
                        <span class="stat-value text-green">{{ driverData.summary.totalDistance | number:'1.0-0' }}</span>
                    </div>
                    <div class="stat-card">
                        <p>Average Speed (Km/h)</p>
                        <span class="stat-value text-green">{{ driverData.summary.avgSpeed | number:'1.0-0' }}</span>
                    </div>
                    <div class="stat-card">
                        <p>Max Speed (Km/h)</p>
                        <span class="stat-value text-green">{{ driverData.summary.maxSpeed | number:'1.0-0' }}</span>
                    </div>
                    <div class="footer-stat">
                        <i class="bi bi-clock-history"></i>
                        <div>
                            <p>Time/Trip</p>
                            <span>{{ driverData.summary.timePerTrip | formatSeconds }}</span>
                        </div>
                    </div>
                    <div class="footer-stat">
                        <i class="bi bi-car-front"></i>
                        <div>
                            <p>Total Driving Time</p>
                            <span>{{ driverData.summary.totalTime | formatSeconds }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="trip-log-section" *ngIf="driverData.dailyTripLog && driverData.dailyTripLog.length > 0">
            <h4 class="trip-log-title">Trip Log</h4>
            <div class="table-responsive">
                <div class="table-scroll-container">
                    <table class="table table-dark">
                    <thead>
                        <tr>
                        <th>Date</th>
                        <th>Start Time</th>
                        <th>Distance</th>
                        <th>Duration</th>
                        <th>Avg. Speed</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let log of driverData.dailyTripLog"
                            [routerLink]="['/dashboard/statistics', driverId, log.tripId]" 
                            style="cursor: pointer;">
                            <td>{{ log.date }}</td>
                            <td>{{ log.startTime }}</td>
                            <td>{{ log.distance }} Km</td>
                            <td>{{ log.duration }}</td>
                            <td>{{ log.avgSpeed }} Km/h</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<ng-template #statusTemplate>
    <div *ngIf="isLoading" class="d-flex flex-column justify-content-center align-items-center" style="height: 80vh;">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h5>Loading Driver Statistics...</h5>
    </div>
    <div *ngIf="!isLoading && hasError" class="d-flex flex-column justify-content-center align-items-center text-center" style="height: 80vh;">
        <h4 class="mb-3">Data Not Found</h4>
        <p class="text-muted mb-4">Could not retrieve statistics for this driver.</p>
        <button class="btn btn-primary" (click)="loadDriverData()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
    </div>
</ng-template>